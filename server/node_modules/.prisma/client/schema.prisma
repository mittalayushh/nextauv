generator client {
  provider      = "prisma-client-js"
  // Ensure Prisma downloads a query engine compatible with deployment targets.
  // Add the runtime used by Vercel serverless: rhel-openssl-3.0.x
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
  // output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  posts            Post[]
  comments         Comment[]
  votes            Vote[]
  communities      Community[] @relation("CommunityMembers")
  ownedCommunities Community[] @relation("CommunityOwner")
}

model Community {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  slug        String   @unique
  createdAt   DateTime @default(now())

  ownerId Int
  owner   User @relation("CommunityOwner", fields: [ownerId], references: [id])

  members User[] @relation("CommunityMembers")
  posts   Post[]
}

model Post {
  id        Int      @id @default(autoincrement())
  title     String
  content   String?
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authorId Int
  author   User @relation(fields: [authorId], references: [id])

  communityId Int
  community   Community @relation(fields: [communityId], references: [id])

  comments Comment[]
  votes    Vote[]
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authorId Int
  author   User @relation(fields: [authorId], references: [id])

  postId Int
  post   Post @relation(fields: [postId], references: [id])

  parentId Int?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  votes Vote[]
}

model Vote {
  id    Int @id @default(autoincrement())
  value Int // 1 for upvote, -1 for downvote

  userId Int
  user   User @relation(fields: [userId], references: [id])

  postId Int?
  post   Post? @relation(fields: [postId], references: [id])

  commentId Int?
  comment   Comment? @relation(fields: [commentId], references: [id])

  @@unique([userId, postId])
  @@unique([userId, commentId])
}
